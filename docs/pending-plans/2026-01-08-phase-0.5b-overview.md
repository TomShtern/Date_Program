# Phase 0.5b: Analytics & Enhanced Matching - Overview

**Date:** 2026-01-08
**Status:** Planning Complete
**Phase:** 0.5b (follows Phase 0.5a Safety & Control)

---

## Executive Summary

Four features to enhance the dating app's core before adding frameworks:

| # | Feature                                                        | Priority | Complexity | Est. Time  |
|---|----------------------------------------------------------------|----------|------------|------------|
| 1 |[Dealbreakers](./2026-01-08-dealbreakers-design.md)             | P1       | Medium     | 6-8 hours  |
| 2 |[Session Tracking](./2026-01-08-swipe-session-tracking-design.md)| P1      | Medium     | 6-8 hours  |
| 3 |[Swipe Stats](./2026-01-08-swipe-statistics-design.md)          | P1       | Medium     | 8-10 hours |
| 4 |[Match Quality](./2026-01-08-match-quality-indicator-design.md) | P2       | Medium     | 8-10 hours |

**Total Estimated Time:** 28-36 hours of focused development

---

## Recommended Implementation Order

```
┌─────────────────────────────────────────────────────────────┐
│  1. DEALBREAKERS                                            │
│     Adds lifestyle fields to User that other features need  │
└──────────────────────────┬──────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────┐
│  2. SWIPE SESSION TRACKING                                  │
│     Infrastructure for analytics, hooks into MatchingService│
└──────────────────────────┬──────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────┐
│  3. SWIPE STATISTICS                                        │
│     Can use session data, requires new storage queries      │
└──────────────────────────┬──────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────┐
│  4. MATCH QUALITY INDICATOR                                 │
│     Uses lifestyle fields from Dealbreakers                 │
└─────────────────────────────────────────────────────────────┘
```

### Why This Order?

1. **Dealbreakers First**
   - Adds lifestyle enums and fields to User
   - Match Quality needs these for lifestyle scoring
   - Independent of other features

2. **Session Tracking Second**
   - Hooks into MatchingService (needs careful integration)
   - Statistics can use session aggregates
   - Anti-bot protection is foundational

3. **Statistics Third**
   - Uses existing Like/Match data + new session data
   - Platform averages needed for derived scores
   - Benefits from session tracking being in place

4. **Match Quality Last**
   - Depends on lifestyle fields (Dealbreakers)
   - Optional dependency on Interests (PRD 0.5 Part 2.1)
   - Highest user-facing value, best saved for polish

---

## Dependency Matrix

```
                    │ Dealbreakers │ Sessions │ Statistics │ Quality │
────────────────────┼──────────────┼──────────┼────────────┼─────────┤
Dealbreakers        │      -       │    No    │     No     │   Yes   │
Session Tracking    │     No       │     -    │   Useful   │    No   │
Swipe Statistics    │     No       │  Useful  │      -     │    No   │
Match Quality       │    Yes*      │    No    │     No     │    -    │

* Match Quality uses lifestyle fields from Dealbreakers
  Without Dealbreakers, lifestyle score will be neutral (0.5)
```

---

## New Domain Models Summary

### From Dealbreakers
```
core/
├── Lifestyle.java          # Container for lifestyle enums
│   ├── Smoking             # NEVER, SOMETIMES, REGULARLY
│   ├── Drinking            # NEVER, SOCIALLY, REGULARLY
│   ├── WantsKids           # NO, OPEN, SOMEDAY, HAS_KIDS
│   ├── LookingFor          # CASUAL, SHORT_TERM, LONG_TERM, MARRIAGE, UNSURE
│   └── Education           # HIGH_SCHOOL, SOME_COLLEGE, BACHELORS, etc.
├── Dealbreakers.java       # User's hard filters (record + builder)
└── DealbreakersEvaluator.java  # Filter logic
```

### From Session Tracking
```
core/
├── SwipeSession.java       # Mutable session entity
└── SessionService.java     # Session lifecycle management
```

### From Statistics
```
core/
├── UserStats.java          # Snapshot of user statistics (record)
├── PlatformStats.java      # Platform-wide averages (record)
└── StatsService.java       # Computation and snapshotting
```

### From Match Quality
```
core/
├── MatchQuality.java       # Quality assessment (record)
├── MatchQualityConfig.java # Scoring weights (record)
└── MatchQualityService.java # Quality computation
```

---

## New Storage Interfaces Summary

```
core/
├── SwipeSessionStorage.java      # Session CRUD + aggregates
├── UserStatsStorage.java         # Stats snapshots
├── PlatformStatsStorage.java     # Platform averages
└── MatchQualityStorage.java      # (Optional) Quality cache
```

---

## Database Schema Additions

### Dealbreakers (alter users table)
```sql
ALTER TABLE users ADD COLUMN smoking VARCHAR(20);
ALTER TABLE users ADD COLUMN drinking VARCHAR(20);
ALTER TABLE users ADD COLUMN wants_kids VARCHAR(20);
ALTER TABLE users ADD COLUMN looking_for VARCHAR(20);
ALTER TABLE users ADD COLUMN education VARCHAR(20);
ALTER TABLE users ADD COLUMN height_cm INT;
ALTER TABLE users ADD COLUMN db_smoking VARCHAR(100);
ALTER TABLE users ADD COLUMN db_drinking VARCHAR(100);
-- ... more dealbreaker columns
```

### Session Tracking
```sql
CREATE TABLE swipe_sessions (
    id UUID PRIMARY KEY,
    user_id UUID NOT NULL,
    started_at TIMESTAMP NOT NULL,
    -- ... session fields
);
```

### Statistics
```sql
CREATE TABLE user_stats (
    id UUID PRIMARY KEY,
    user_id UUID NOT NULL,
    computed_at TIMESTAMP NOT NULL,
    -- ... stat fields
);

CREATE TABLE platform_stats (
    id UUID PRIMARY KEY,
    computed_at TIMESTAMP NOT NULL,
    -- ... aggregate fields
);
```

### Match Quality (Optional Cache)
```sql
CREATE TABLE match_quality_cache (
    id UUID PRIMARY KEY,
    match_id VARCHAR(100) NOT NULL,
    perspective_user_id UUID NOT NULL,
    -- ... quality fields
);
```

---

## Console UI Additions

### New Menu Options
```
═══════════════════════════════════════
         DATING APP - PHASE 0.5b
═══════════════════════════════════════
  Current User: Alice (ACTIVE)
  Session: 12 swipes | 3:24 elapsed     <-- NEW (Session Tracking)
───────────────────────────────────────
  1. Create new user
  2. Select existing user
  3. Complete/edit my profile
  4. Browse candidates
  5. View my matches                    <-- Enhanced (Match Quality)
  6. Block a user
  7. Report a user
  8. View my statistics                 <-- NEW (Statistics)
  9. Set dealbreakers                   <-- NEW (Dealbreakers)
  0. Exit
═══════════════════════════════════════
```

### Enhanced Screens
- Profile completion includes lifestyle questions
- Match list shows compatibility scores
- Match detail shows why you matched
- Statistics screen shows engagement metrics

---

## Testing Strategy

### Test Count Estimates

| Feature          | Unit Tests | Integration Tests |
|------------------|------------|-------------------|
| Dealbreakers     | 12-15      | 3-5               |
| Session Tracking | 10-12      | 3-4               |
| Statistics       | 10-12      | 4-5               |
| Match Quality    | 12-15      | 2-3               |
| **Total**        | **44-54**  | **12-17**         |

### Critical Test Scenarios

1. **Dealbreakers**: Missing candidate fields should fail dealbreakers
2. **Sessions**: Timeout detection and cleanup works correctly
3. **Statistics**: Division by zero handled in all ratio calculations
4. **Quality**: Graceful degradation when lifestyle data missing

---

## Risk Mitigation

| Risk                              | Mitigation                                   |
|-----------------------------------|----------------------------------------------|
| User data bloat (stats snapshots) | Keep last N snapshots, cleanup job           |
| Session not ending (memory leak)  | Timeout-based cleanup, stale detection       |
| Match quality too slow            | Cache results, invalidate on profile change  |
| Dealbreakers too restrictive      | Show warning if filters eliminate most users |

---

## Success Criteria (Phase 0.5b Complete)

- [ ] All 4 features implemented and tested
- [ ] All unit tests passing
- [ ] All integration tests passing
- [ ] Console UI updated for all features
- [ ] Data persists between restarts
- [ ] Zero framework imports in `core/`
- [ ] Performance acceptable (<100ms for computations)
- [ ] CLAUDE.md updated to reflect new components

---

## What's NOT Included

These are explicitly out of scope for Phase 0.5b:

- Interests/Tags (PRD 0.5 Part 2.1) - Can add later, Quality degrades gracefully
- Match Scoring Strategies (PRD 0.5 Part 2.2) - Complex refactor, defer
- Activity Recency (PRD 0.5 Part 2.3) - Simple, can add anytime
- Daily Swipe Limits (PRD 0.5 Part 3.1) - Can add with Sessions
- Super Like (PRD 0.5 Part 3.2) - Enum addition, simple
- "Who Liked Me" (PRD 0.5 Part 3.3) - Query addition, medium
- Messaging (PRD 0.5 Part 4) - Large feature, separate phase

---

## Next Steps

1. Review this overview and individual design docs
2. Approve or request changes
3. Start implementation with Dealbreakers
4. Mark each feature complete in this doc as we go

---

**Ready to begin implementation when you approve.**
